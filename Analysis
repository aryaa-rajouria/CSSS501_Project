

# TO DO LIST: 

# - FIGURE OUT HOW TO PROPERLY TEST THE PROPORTIONAL ODDS ASSUMPTION FOR M1aa-dd
# - WOULD BE HELPFUL TO FIGURE OUT HOW TO MAKE A CORRELATION MATRIX - TO SHOW WHAT CHARACTERISTICS OCCUR TOGETHER
# - FIGURE OUT HOW TO MAKE FIGURES WITH OUR RESULTS, SIMCF CURRENTLY NOT WORKING WITH OUR TYPE OF DATA
# - FIGURE OUT HOW TO PERFORM A MORE RIGOROUS GOODNESS OF FIT TEST, CURRENTLY GOING OFF OF AIC VALUE
# - IT MIGHT BE INTERESTING TO DISAGGREGATE THE 2ND SET OF ANALYSES BY GENDER - WOMEN HAVE A HIGHER ODDS OF POOR MENTAL HEALTH ACROSS ALL PYSCHO-SOCIAL FACTORS

# ANALYSIS 

library(brant)
library(MASS)
library(simcf)
library(VGAM)
library(RColorBrewer)
library(verification)
library(tile)
library(dplyr) # when you load MASS and dplyr select is overwritten

options(scipen = 999)
fdata <- read.csv('/Users/katherine/fdata4.csv')

# 1. HOW DO THE FOLLOWING PYSCHO-SOCIAL FACTORS AFFECT SELF-RATED HEALTH? 

# M1aa: Does eds decrease self rated health?

m1aa <- polr(as.factor(srh) ~ eds + age + gender + doc_status + income + married.LT + race + edu_highest
             + eng_read + migrant_2, data=fdata, method="probit")
summary(m1aa)

# testing the proportional odds assumption using a brant test 
# NOTE: Not sure if this test is totally accurate, since it works but gives a warning
# Brant test does not work because we have too many covariates with small numbers, test is unable to test all possible combinations

brant(m1aa)

summary(m1aa)

# Computing the CI
ci_m1aa <- confint(m1aa)

m1aa_res <- round(exp(cbind(OR = (coef(m1aa)), ci_m1aa)),3)
m1aa_res

# computing the p-values, just in case we want them
summary_table <- coef(summary(m1aa))
pval <- pnorm(abs(summary_table[, "t value"]),lower.tail = FALSE)* 2
summary_table <- cbind(summary_table, "p value" = round(pval,3))
summary_table

# M1bb: DOES EPD DECREASE SELF RATED HEALTH?

m1bb <- polr(as.factor(srh) ~ epd + age + gender + doc_status + income + married.LT + race + edu_highest
             + eng_read + migrant_2, data=fdata, method='probit')
summary(m1bb)
brant(m1bb)

# computing CI
ci_m1bb <- confint(m1bb)

m1bb_res <- round(exp(cbind(OR = (coef(m1bb)), ci_m1bb)),3)
m1bb_res

# computing the p-values
summary_table <- coef(summary(m1bb))
pval <- pnorm(abs(summary_table[, "t value"]),lower.tail = FALSE)* 2
summary_table <- cbind(summary_table, "p value" = round(pval,3))
summary_table

# M1cc: DOES LOW CONTROL DECREASE SELF RATED HEALTH? 

m1cc <- polr(as.factor(srh) ~ lowcont + age + gender + doc_status + income + married.LT + race + edu_highest
             + eng_read + migrant_2, data=fdata, method='probit')
summary(m1cc)
brant(m1cc)

# computing CI
ci_m1bb <- confint(m1bb)

m1bb_res <- round(exp(cbind(OR = (coef(m1bb)), ci_m1bb)),3)
m1bb_res

# computing the p-values
summary_table <- coef(summary(m1bb))
pval <- pnorm(abs(summary_table[, "t value"]),lower.tail = FALSE)* 2
summary_table <- cbind(summary_table, "p value" = round(pval,3))
summary_table

# M1d: DOES JOB STRAIN DECREASE SELF RATED HEALTH? 

m1dd <- polr(as.factor(srh) ~ job_strain + age + gender + doc_status + income + married.LT + race + edu_highest
             + eng_read + migrant_2, data=fdata, method='probit')
summary(m1dd)
brant(m1dd)

# computing CI
ci_m1dd <- confint(m1dd)

m1dd_res <- round(exp(cbind(OR = (coef(m1dd)), ci_m1dd)),3)
m1dd_res

# computing the p-values
summary_table <- coef(summary(m1dd))
pval <- pnorm(abs(summary_table[, "t value"]),lower.tail = FALSE)* 2
summary_table <- cbind(summary_table, "p value" = round(pval,3))
summary_table

# 2. TO WHAT EXTENT DOES SOCIAL SUPPORT MODERATE STRESSORS, SPECIFICALLY DOC STATUS? 

# WE EXAMINE 3 TYPES OF SOCIAL SUPPORT: SOCIAL ASSISTANCE (0/1), ESL CLASSES (0/1), AND HEALTH INSURANCE (0/1)

# EDS

m2aa <- glm(eds ~ hh_social_assist + esl_class + age + gender + doc_status + doc_status*hh_social_assist
            + doc_status*esl_class + doc_status*health_in + income + married.LT + race 
            + edu_highest + eng_read + migrant_2, data=fdata, family=binomial)

summary(m2aa)
exp(coef(m2aa))

# EPD

m2bb <- glm(epd ~ hh_social_assist + esl_class + age + gender + doc_status + doc_status*hh_social_assist
            + doc_status*esl_class + doc_status*health_in + income + married.LT + race 
            + edu_highest + eng_read + migrant_2, data=fdata, family=binomial)

summary(m2bb)
exp(coef(m2bb))

# Low control

m2cc <- glm(lowcont ~ hh_social_assist + esl_class + age + gender + doc_status + doc_status*hh_social_assist
            + doc_status*esl_class + doc_status*health_in + income + married.LT + race 
            + edu_highest + eng_read + migrant_2, data=fdata, family=binomial)

summary(m2cc)
exp(coef(m2cc))

# Job strain

m2dd <- glm(job_strain ~ hh_social_assist + esl_class + age + gender + doc_status + doc_status*hh_social_assist
            + doc_status*esl_class + doc_status*health_in + income + married.LT + race 
            + edu_highest + eng_read + migrant_2, data=fdata, family=binomial)

summary(m2dd)
exp(coef(m2dd))

# FIGURE - WE USE A BINARY INDICATOR OF SOCIAL ASSISTANCE, BUT CAN EXPLORE WHAT TYPES OF SOCIAL ASSISTANCE ARE MOST COMMON

# bar plot
cols_to_include <- c('hh_dis_ins', 'hh_dis_rel', 'hh_food_stamps', 'hh_gen_as', 'hh_leg_ser', 'hh_soc_sec', 
                     'hh_vet_pay', 'hh_li_house', 'hh_other', 'hh_phealth_cl','hh_unemp_ins',
                     'hh_medicaid','hh_TANF', 'hh_wic')
fdata %>% mutate(obs_idx=row_number()) %>%select(obs_idx, all_of(cols_to_include)) %>% 
  pivot_longer(cols = all_of(cols_to_include)) %>%filter(!is.na(value)) %>%
  group_by(name) %>% summarize(n=sum(value), .groups='drop') %>% arrange(-n) %>% 
  ggplot(aes(x=factor(name, levels=unique(name)), y=n)) + geom_bar(stat='identity') +
  theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1),
        axis.title.x = element_blank()) +
  ylab("Counts")

# FIGURE - WE SHOW THAT SOCIAL ASSISTANCE IS RECIEVED BY NON-CITIZENS

# table of social assistance by doc status
table1 <- table(fdata$doc_status, fdata$hh_social_assist)
colnames(table1) <- c('no', 'yes')















